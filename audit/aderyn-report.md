# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.

# Table of Contents

-   [Summary](#summary)
    -   [Files Summary](#files-summary)
    -   [Files Details](#files-details)
    -   [Issue Summary](#issue-summary)
-   [High Issues](#high-issues)
    -   [H-1: Return value of the function call is not checked.](#h-1-return-value-of-the-function-call-is-not-checked)
-   [Low Issues](#low-issues)
    -   [L-1: Centralization Risk for trusted owners](#l-1-centralization-risk-for-trusted-owners)
    -   [L-2: Unsafe ERC20 Operations should not be used](#l-2-unsafe-erc20-operations-should-not-be-used)
    -   [L-3: Missing checks for `address(0)` when assigning values to address state variables](#l-3-missing-checks-for-address0-when-assigning-values-to-address-state-variables)
    -   [L-4: Event is missing `indexed` fields](#l-4-event-is-missing-indexed-fields)
    -   [L-5: Internal functions called only once can be inlined](#l-5-internal-functions-called-only-once-can-be-inlined)
    -   [L-6: Unused Custom Error](#l-6-unused-custom-error)

# Summary

## Files Summary

| Key         | Value |
| ----------- | ----- |
| .sol Files  | 8     |
| Total nSLOC | 787   |

## Files Details

| Filepath                               | nSLOC   |
| -------------------------------------- | ------- |
| src/BaseStaking.sol                    | 121     |
| src/DelegateStaking.sol                | 101     |
| src/RewardsDistributor.sol             | 96      |
| src/Staking.sol                        | 102     |
| src/interfaces/IERC20.sol              | 14      |
| src/interfaces/IRewardsDistributor.sol | 12      |
| src/libraries/EnumerableSetLib.sol     | 299     |
| src/libraries/FixedPointMathLib.sol    | 42      |
| **Total**                              | **787** |

## Issue Summary

| Category | No. of Issues |
| -------- | ------------- |
| High     | 1             |
| Low      | 6             |

# High Issues

## H-1: Return value of the function call is not checked.

Function returns a value but it is ignored.

<details><summary>9 Found Instances</summary>

-   Found in src/BaseStaking.sol [Line: 83](src/BaseStaking.sol#L83)

    ```solidity
            rewardsDistributor.collectRewards();
    ```

-   Found in src/DelegateStaking.sol [Line: 155](src/DelegateStaking.sol#L155)

    ```solidity
            userStakes[msg.sender].add(stakeId);
    ```

-   Found in src/DelegateStaking.sol [Line: 229](src/DelegateStaking.sol#L229)

    ```solidity
                userStakes[msg.sender].remove(stakeId);
    ```

-   Found in src/RewardsDistributor.sol [Line: 97](src/RewardsDistributor.sol#L97)

    ```solidity
            rewardToken.transfer(msg.sender, rewards);
    ```

-   Found in src/RewardsDistributor.sol [Line: 131](src/RewardsDistributor.sol#L131)

    ```solidity
            rewardToken.transfer(receiver, rewards);
    ```

-   Found in src/RewardsDistributor.sol [Line: 153](src/RewardsDistributor.sol#L153)

    ```solidity
                collectRewardsTo(receiver);
    ```

-   Found in src/RewardsDistributor.sol [Line: 202](src/RewardsDistributor.sol#L202)

    ```solidity
            IERC20(token).transfer(to, amount);
    ```

-   Found in src/Staking.sol [Line: 163](src/Staking.sol#L163)

    ```solidity
            userStakes[msg.sender].add(stakeId);
    ```

-   Found in src/Staking.sol [Line: 250](src/Staking.sol#L250)

    ```solidity
                userStakes[keyper].remove(stakeId);
    ```

</details>

# Low Issues

## L-1: Centralization Risk for trusted owners

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>10 Found Instances</summary>

-   Found in src/BaseStaking.sol [Line: 151](src/BaseStaking.sol#L151)

    ```solidity
        ) external onlyOwner {
    ```

-   Found in src/BaseStaking.sol [Line: 159](src/BaseStaking.sol#L159)

    ```solidity
        function setLockPeriod(uint256 _lockPeriod) external onlyOwner {
    ```

-   Found in src/DelegateStaking.sol [Line: 247](src/DelegateStaking.sol#L247)

    ```solidity
        function setStakingContract(address _stakingContract) external onlyOwner {
    ```

-   Found in src/RewardsDistributor.sol [Line: 13](src/RewardsDistributor.sol#L13)

    ```solidity
    contract RewardsDistributor is Ownable, IRewardsDistributor {
    ```

-   Found in src/RewardsDistributor.sol [Line: 142](src/RewardsDistributor.sol#L142)

    ```solidity
        ) external override onlyOwner {
    ```

-   Found in src/RewardsDistributor.sol [Line: 165](src/RewardsDistributor.sol#L165)

    ```solidity
        ) external override onlyOwner {
    ```

-   Found in src/RewardsDistributor.sol [Line: 174](src/RewardsDistributor.sol#L174)

    ```solidity
        function setRewardToken(address _rewardToken) external override onlyOwner {
    ```

-   Found in src/RewardsDistributor.sol [Line: 197](src/RewardsDistributor.sol#L197)

    ```solidity
        ) public override onlyOwner {
    ```

-   Found in src/Staking.sol [Line: 264](src/Staking.sol#L264)

    ```solidity
        function setMinStake(uint256 _minStake) external onlyOwner {
    ```

-   Found in src/Staking.sol [Line: 274](src/Staking.sol#L274)

    ```solidity
        function setKeyper(address keyper, bool isKeyper) external onlyOwner {
    ```

</details>

## L-2: Unsafe ERC20 Operations should not be used

ERC20 functions may not behave as expected. For example: return values are not always meaningful. It is recommended to use OpenZeppelin's SafeERC20 library.

<details><summary>7 Found Instances</summary>

-   Found in src/BaseStaking.sol [Line: 120](src/BaseStaking.sol#L120)

    ```solidity
            stakingToken.transfer(msg.sender, rewards);
    ```

-   Found in src/BaseStaking.sol [Line: 209](src/BaseStaking.sol#L209)

    ```solidity
            stakingToken.transferFrom(msg.sender, address(this), amount);
    ```

-   Found in src/BaseStaking.sol [Line: 230](src/BaseStaking.sol#L230)

    ```solidity
            stakingToken.transfer(user, amount);
    ```

-   Found in src/BaseStaking.sol [Line: 270](src/BaseStaking.sol#L270)

    ```solidity
            stakingToken.transferFrom(msg.sender, address(this), amount);
    ```

-   Found in src/RewardsDistributor.sol [Line: 97](src/RewardsDistributor.sol#L97)

    ```solidity
            rewardToken.transfer(msg.sender, rewards);
    ```

-   Found in src/RewardsDistributor.sol [Line: 131](src/RewardsDistributor.sol#L131)

    ```solidity
            rewardToken.transfer(receiver, rewards);
    ```

-   Found in src/RewardsDistributor.sol [Line: 202](src/RewardsDistributor.sol#L202)

    ```solidity
            IERC20(token).transfer(to, amount);
    ```

</details>

## L-3: Missing checks for `address(0)` when assigning values to address state variables

Check for `address(0)` when assigning values to address state variables.

<details><summary>6 Found Instances</summary>

-   Found in src/DelegateStaking.sol [Line: 126](src/DelegateStaking.sol#L126)

    ```solidity
            staking = IStaking(_stakingContract);
    ```

-   Found in src/DelegateStaking.sol [Line: 127](src/DelegateStaking.sol#L127)

    ```solidity
            stakingToken = ERC20Votes(_stakingToken);
    ```

-   Found in src/DelegateStaking.sol [Line: 128](src/DelegateStaking.sol#L128)

    ```solidity
            rewardsDistributor = IRewardsDistributor(_rewardsDistributor);
    ```

-   Found in src/RewardsDistributor.sol [Line: 72](src/RewardsDistributor.sol#L72)

    ```solidity
            rewardToken = IERC20(_rewardToken);
    ```

-   Found in src/Staking.sol [Line: 126](src/Staking.sol#L126)

    ```solidity
            stakingToken = ERC20Votes(_stakingToken);
    ```

-   Found in src/Staking.sol [Line: 127](src/Staking.sol#L127)

    ```solidity
            rewardsDistributor = IRewardsDistributor(_rewardsDistributor);
    ```

</details>

## L-4: Event is missing `indexed` fields

Index event fields make the field more quickly accessible to off-chain tools that parse events. However, note that each index field costs extra gas during emission, so it's not necessarily best to index the maximum allowed per event (three fields). Each event should use three indexed fields if there are three or more fields, and gas usage is not particularly of concern for the events in question. If there are fewer than three fields, all of the fields should be indexed.

<details><summary>10 Found Instances</summary>

-   Found in src/BaseStaking.sol [Line: 53](src/BaseStaking.sol#L53)

    ```solidity
    event RewardsClaimed(address indexed user, uint256 rewards);
    ```

-   Found in src/DelegateStaking.sol [Line: 77](src/DelegateStaking.sol#L77)

    ```solidity
        event Staked(
    ```

-   Found in src/DelegateStaking.sol [Line: 85](src/DelegateStaking.sol#L85)

    ```solidity
    event Unstaked(address indexed user, uint256 amount, uint256 shares);
    ```

-   Found in src/RewardsDistributor.sol [Line: 42](src/RewardsDistributor.sol#L42)

    ```solidity
        event RewardConfigurationSet(
    ```

-   Found in src/RewardsDistributor.sol [Line: 47](src/RewardsDistributor.sol#L47)

    ```solidity
    event RewardCollected(address indexed receiver, uint256 reward);
    ```

-   Found in src/Staking.sol [Line: 77](src/Staking.sol#L77)

    ```solidity
    event Staked(address indexed user, uint256 amount, uint256 lockPeriod);
    ```

-   Found in src/Staking.sol [Line: 80](src/Staking.sol#L80)

    ```solidity
    event Unstaked(address indexed user, uint256 amount, uint256 shares);
    ```

-   Found in src/Staking.sol [Line: 83](src/Staking.sol#L83)

    ```solidity
    event KeyperSet(address indexed keyper, bool isKeyper);
    ```

-   Found in src/interfaces/IERC20.sol [Line: 15](src/interfaces/IERC20.sol#L15)

    ```solidity
    event Transfer(address indexed from, address indexed to, uint256 value);
    ```

-   Found in src/interfaces/IERC20.sol [Line: 21](src/interfaces/IERC20.sol#L21)

    ```solidity
        event Approval(
    ```

</details>

## L-5: Internal functions called only once can be inlined

Instead of separating the logic into a separate function, consider inlining the logic into the calling function. This can reduce the number of function calls and improve readability.

<details><summary>7 Found Instances</summary>

-   Found in src/libraries/EnumerableSetLib.sol [Line: 82](src/libraries/EnumerableSetLib.sol#L82)

    ```solidity
        function length(
    ```

-   Found in src/libraries/EnumerableSetLib.sol [Line: 121](src/libraries/EnumerableSetLib.sol#L121)

    ```solidity
        function add(
    ```

-   Found in src/libraries/EnumerableSetLib.sol [Line: 201](src/libraries/EnumerableSetLib.sol#L201)

    ```solidity
        function contains(
    ```

-   Found in src/libraries/EnumerableSetLib.sol [Line: 251](src/libraries/EnumerableSetLib.sol#L251)

    ```solidity
        function remove(
    ```

-   Found in src/libraries/EnumerableSetLib.sol [Line: 323](src/libraries/EnumerableSetLib.sol#L323)

    ```solidity
        function values(
    ```

-   Found in src/libraries/FixedPointMathLib.sol [Line: 28](src/libraries/FixedPointMathLib.sol#L28)

    ```solidity
        function mulDivDown(
    ```

-   Found in src/libraries/FixedPointMathLib.sol [Line: 47](src/libraries/FixedPointMathLib.sol#L47)

    ```solidity
        function mulDivUp(
    ```

</details>

## L-6: Unused Custom Error

it is recommended that the definition be removed when custom error is unused

<details><summary>21 Found Instances</summary>

-   Found in src/BaseStaking.sol [Line: 61](src/BaseStaking.sol#L61)

    ```solidity
    error WithdrawAmountTooHigh();
    ```

-   Found in src/BaseStaking.sol [Line: 68](src/BaseStaking.sol#L68)

    ```solidity
    error NoRewardsToClaim();
    ```

-   Found in src/BaseStaking.sol [Line: 71](src/BaseStaking.sol#L71)

    ```solidity
    error AddressZero();
    ```

-   Found in src/BaseStaking.sol [Line: 74](src/BaseStaking.sol#L74)

    ```solidity
    error UserHasNoShares();
    ```

-   Found in src/DelegateStaking.sol [Line: 95](src/DelegateStaking.sol#L95)

    ```solidity
    error ZeroAmount();
    ```

-   Found in src/DelegateStaking.sol [Line: 99](src/DelegateStaking.sol#L99)

    ```solidity
    error StakeDoesNotBelongToUser();
    ```

-   Found in src/DelegateStaking.sol [Line: 102](src/DelegateStaking.sol#L102)

    ```solidity
    error StakeDoesNotExist();
    ```

-   Found in src/DelegateStaking.sol [Line: 105](src/DelegateStaking.sol#L105)

    ```solidity
    error StakeIsStillLocked();
    ```

-   Found in src/DelegateStaking.sol [Line: 108](src/DelegateStaking.sol#L108)

    ```solidity
    error AddressIsNotAKeyper();
    ```

-   Found in src/RewardsDistributor.sol [Line: 56](src/RewardsDistributor.sol#L56)

    ```solidity
    error ZeroAddress();
    ```

-   Found in src/RewardsDistributor.sol [Line: 59](src/RewardsDistributor.sol#L59)

    ```solidity
    error EmissionRateZero();
    ```

-   Found in src/RewardsDistributor.sol [Line: 62](src/RewardsDistributor.sol#L62)

    ```solidity
    error NotEnoughFunds();
    ```

-   Found in src/RewardsDistributor.sol [Line: 65](src/RewardsDistributor.sol#L65)

    ```solidity
    error TimeDeltaZero();
    ```

-   Found in src/Staking.sol [Line: 90](src/Staking.sol#L90)

    ```solidity
    error OnlyKeyper();
    ```

-   Found in src/Staking.sol [Line: 94](src/Staking.sol#L94)

    ```solidity
    error FirstStakeLessThanMinStake();
    ```

-   Found in src/Staking.sol [Line: 97](src/Staking.sol#L97)

    ```solidity
    error ZeroAmount();
    ```

-   Found in src/Staking.sol [Line: 101](src/Staking.sol#L101)

    ```solidity
    error StakeDoesNotBelongToUser();
    ```

-   Found in src/Staking.sol [Line: 104](src/Staking.sol#L104)

    ```solidity
    error StakeDoesNotExist();
    ```

-   Found in src/Staking.sol [Line: 107](src/Staking.sol#L107)

    ```solidity
    error StakeIsStillLocked();
    ```

-   Found in src/libraries/EnumerableSetLib.sol [Line: 20](src/libraries/EnumerableSetLib.sol#L20)

    ```solidity
    error IndexOutOfBounds();
    ```

-   Found in src/libraries/EnumerableSetLib.sol [Line: 23](src/libraries/EnumerableSetLib.sol#L23)

    ```solidity
    error ValueIsZeroSentinel();
    ```

</details>
